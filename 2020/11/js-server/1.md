
## 如何在docker容器中调试Node.js应用

> 在本文中，我将教您如何在Docker容器中调试Node.js应用程序，以捕获无法以其他任何方式发现的错误。

在本文中，我们将介绍如何在Docker容器中调试Node.js应用程序。

> 如果您想知道：“我为什么要获得这些知识？”答案其实很简单：

在大多数情况下，您可以在本地计算机上运行应用程序，并仅使用容器对数据库和消息传递队列进行沙箱处理，但是只有在将应用程序自身也进行容器化后，某些错误才会显示出来。 在这些情况下，了解如何将调试器添加到应用中是非常有帮助的。

根据基金会的Node.js开发人员调查结果，有一半的Node.js用户使用Docker进行开发。 一般而言，容器化是一个非常强大的工具-在RisingStack，我们总是通过在docker-compose.yaml中分解所需的基础结构来启动新项目-如果您不这样做，则很难达到对Node应用进程的容器化封装。

> 如果您需要有关Docker，Kubernetes，微服务或Node.js的指导，请随时通过info@risingstack.com ping我们或通过我们的网站与我们联系！

这篇文章中使用的所有代码段和设置都可以在其专用的GitHub存储库中找到。

#### 怎么使用Node检查器

如果您主要使用printf（又称为原始人调试），那么您将很难在正确的时间找到正确的结果值。

如果每次将console.log添加到容器镜像时都必须重建容器镜像，情况会变得更糟。 一次性构建镜像并在其中跳来跳去，在运行时检查变量可能会容易得多。 为了更好地了解我们将在此处执行的操作，我强烈建议您首先熟悉Node检查器命令。

要在调试模式下运行Node应用程序，只需在node后添加检查，如下所示：

当您在检查模式下运行代码时，它总是在第一行停止，等待您与之交互。 对于那些使用gdb调试代码的人来说，这个接口可能很吸引人。 但是，如果您习惯于使用GUI与调试器进行交互，则可能要打开chrome并浏览至chrome：// inspect。

您应该会看到以下内容：

在远程目标下，点击检查，然后您会看到Chrome开发者工具调试器。

现在，您可以随意使用调试器。现在是时候将我们的应用程序安装配置在容器中了。

#### 在Docker容器中调试Node.js

首先，我们需要创建一个Dockerfile。

和一个docker-compose.yaml文件。

现在，如果您运行docker-compose up 命令，您将能够在http：// localhost：3000上访问您的服务。

下一步是将调试端口暴露给外界。首先，让我们创建一个debug-compose.yaml文件。

如您所见，我们打开了端口9229，这是Node.js应用程序的调试端口。我们还将覆盖我们在Dockerfile中指定的命令。 --inspect-brk = 0.0.0.0参数执行两项不同的操作：

--inspect 命令告诉Node我们要在调试模式下运行我们的应用程序。

通过添加-brk命令，我们还应该确保该应用程序在第一行能够停止，以便我们有足够的时间打开检查器。

添加= 0.0.0.0会让调试器能够打开到来自任何IP的连接。

默认情况下，检查器绑定到127.0.0.1，这使很有意义，因为我们通常不希望世界各地的开发者们将调试器附加到我们的应用程序中。但是，容器是与我们的主机具有不同IP的虚拟主机，因此我们将无法访问它。只要在本地进行就可以了。但是，我们不想在这样的实时服务器上运行它。

因此，请确保它与docker-compose.yaml是不同的文件。

通过进一步的操作，您可以将调试集群从暂存群集公开到公网IP（但在这种情况下，仅公开给IP），并在那里调试问题。

另外，请注意，端口转发规则用“ -s”括起来。如果省略引号，则该规则可能不起作用，从而很难弄清为什么无法将调试器附加到应用进程中。

综上所述，您应该能够在开发工具中检查您的应用程序了。

Node.js Docker开发工具

使用Visual Studio代码进行调试

使用检查器解决单个文件问题非常好，尽管在发现项目中的所有文件时可能会遇到问题。在这种情况下，最好附加IDE提供的调试器。让我们看看如何用Visual Studio Code完成它。

首先，导航到调试选项卡

Node.js Docker VSCode面板

然后点击齿轮图标

Node.js Docker调试器设置

从弹出列表中，选择docker（确保已安装Docker扩展）

Node.js Docker VSCode调试器弹出窗口

它应在项目.vscode文件夹中生成如下所示的launch.json：

Node.js Docker Launch.json

通常都是可以的，尽管在我们的例子中，应用程序的根目录是容器文件系统的根目录，所以我们也需要对其进行更新。完成后，对象应如下所示：

{
  “ name”：“ Docker：附加到节点”，
  “ type”：“节点”，
  “ request”：“ attach”，
  “端口”：9229，
  “ address”：“ localhost”，
  “ localRoot”：“ $ {workspaceFolder}”，
  “ remoteRoot”：“ /”，
  “ protocol”：“检查员”
}

现在，如果您在键盘上按F5键，系统将提示您使用VSCode习惯的调试器。再次按F5，以使服务器开始监听。如果在某处放置断点并在http：// localhost：3000上调用服务器，则应该看到此信息

Node.js Docker VSCode调试器

为什么不使用ndb？

尽管ndb非常适合调试，但您目前无法将其附加到正在运行的进程中，这几乎破坏了本例的目的。

您也可以在容器内部使用它启动调试过程，并从外部将调试器附加到if，但是您还需要修改Dockerfile来这样做，并且您实际上并没有收获任何东西，因为您需要附加chrome vscode或其他调试器。请关注此问题以获取有关此事的最新消息。

关于Node.js调试的最终想法

看到诸如Kubernetes，AWS ECS，Docker Swarm之类的容器技术正在变得越来越广泛，显然容器将继续存在。

如果您需要有关Docker，Kubernetes，微服务或Node.js的指导，请随时通过info@risingstack.com ping我们或通过我们的网站与我们联系！

您可以在开发过程中在本地计算机上运行相同的映像并最终将其放置在群集上，这一事实绝对是一件好事，因为您可以将应用程序与配置捆绑在一起并将它们部署在一起。但是，当您依赖于printf调试时，很难找到仅在捆绑了该应用程序时才会显示的错误，因此，即使您到目前为止还没有使用过它，与调试器成为朋友并学习如何进行调试也是一个不错的主意。将它们附加到容器中运行的进程。

调试愉快！

当我们遇到一个仅在使用@fazekasda的容器中出现的错误时，便产生了这篇文章的想法。感谢您的帮助！
